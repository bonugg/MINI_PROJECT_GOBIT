<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/layout}">
<head>
    <meta charset="UTF-8">
    <title>Empty</title>

    <th:block layout:fragment="css">
        <!--사용할 css는 여기에 첨부 -->
        <link rel="stylesheet" type="text/css" href="/css/empty.css">
        <link rel="stylesheet" type="text/css" href="css/pwChange.css">
    </th:block>
</head>
<body layout:fragment="content">

<div id="fullscreen">
    <div id="_emt1"></div>
    <div id="_emt2">
        <div id="_emt3">
        </div>
        <div id="_emt4">
            <div id="use_screen">
                <p class="pwChange-title">비밀번호 변경</p>
                <form method="post" action="/changePw" id="changePwForm">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                    <input type="password" name="USER_PWD" id="originPw" placeholder="기존 비밀번호"/>
                    <button type="button" id="btnOriginPwCheck" style="width: 70px">기존 비밀번호 확인</button>
                    <p id="originPwCheck" style="color: blue; font-size: 0.8rem;"></p>
                    <input type="password" name="NEW_USER_PWD" id="changePw" placeholder="변경 비밀번호"/>
                    <p id="pwValidation" style="color: red; font-size: 0.8rem;">
                        비밀번호는 영문자, 숫자, 특수문자 조합의 9자리 이상으로 설정해주세요.
                    </p>
                    <input type="password" name="PWDCHECK" id="newPwChk" placeholder="변경 비밀번호 확인"/>
                    <p id="pwCheckResult" style="font-size: 0.8rem;"></p>
                    <button type="submit" class="changebtn">비밀번호 변경</button>
                </form>

            </div>
        </div>
    </div>
</div>
</body>
<th:block layout:fragment="script">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.9-1/crypto-js.min.js"></script>
    <!--사용할 자바스크립트는 여기에 첨부 -->
    <script>
        $(function() {
            $("#pwValidation").hide();
            $("#pwCheckResult").hide();
            $("#originPwCheck").hide();

            let pwValidation = false;
            let pwChk = false;
            let checkOriginPw = false;

            // 기존 비밀번호 확인 버튼 이벤트 처리
            $("#btnOriginPwCheck").on("click", () => {
                const originPw = $("#originPw").val();
                const hashHex = CryptoJS.SHA256(originPw).toString(CryptoJS.enc.Hex);

                $.ajax({
                    type: "POST",
                    url: "/originPw-check",
                    data: { encryptedOriginPw: hashHex },
                    success: function (data) {
                        if (data.item.pwCheckMsg === "pwFail") {
                            checkOriginPw = false;
                            $("#originPwCheck").css("color", "red");
                            $("#originPwCheck").text("기존 비밀번호와 일치하지 않습니다.");
                        } else if (data.item.pwCheckMsg === "pwOk") {
                            checkOriginPw = true;
                            $("#originPwCheck").show();
                            $("#originPwCheck").css("color", "green");
                            $("#originPwCheck").text("기존 비밀번호와 일치합니다.");
                            $("#btnOriginPwCheck").attr("disabled", true).css("opacity", "0.5");
                        }
                    },
                    error: (error) => {
                        console.log(error);
                    }
                });
                const validatePassword = (character) => {
                    return /^(?=.*[a-zA-Z])(?=.*[!@#$%^&*+=-])(?=.*[0-9]).{8,}$/.test(character);
                }

                //비밀번호 변경시 유효성 검사
                $("#changePw").on("change", () => {
                    if(validatePassword($("#changePw").val())) {
                        pwValidation = true;
                        $("#pwValidation").hide();
                    } else {
                        pwValidation = false;
                        $("#pwValidation").show();
                        $("#changePw").focus();
                    }

                    //비밀번호 확인까지 완료후 다시 비밀번호 재설정 할 때
                    if($("#changePw").val() === $("#newPwChk").val()) {
                        pwChk = true;
                        $("#pwCheckResult").css("color", "green");
                        $("#pwCheckResult").text("비밀번호가 일치합니다.");
                    } else {
                        pwChk = false;
                        $("#pwCheckResult").css("color", "red");
                        $("#pwCheckResult").text("비밀번호가 일치하지 않습니다.");
                    }
                });

                //비밀번호 확인과 비밀번호가 일치하는 지 여부 검사
                $("#newPwChk").on("change", () => {
                    $("#pwCheckResult").show();

                    if($("#changePw").val() === $("#newPwChk").val()) {
                        pwChk = true;
                        $("#pwCheckResult").css("color", "blue");
                        $("#pwCheckResult").text("비밀번호가 일치합니다.");
                    } else {
                        pwChk = false;
                        $("#pwCheckResult").css("color", "red");
                        $("#pwCheckResult").text("비밀번호가 일치하지 않습니다.");
                    }
                });
                $("#changePwForm").on("submit", () => {
                    let pwValidation = (character) => {
                        return /^(?=.*[a-zA-Z])(?=.*[!@#$%^&*+=-])(?=.*[0-9]).{9,}$/.test(character);
                        let pwChk = ($("#changePw").val() === $("#newPwChk").val());

                        if (!checkOriginPw) {
                            alert("기존 비밀번호 확인을 진행해주세요.");
                            return;
                        }

                        if (!pwValidation) {
                            alert("비밀번호는 영문자, 숫자, 특수문자 조합의 9자리 이상으로 설정하세요.");
                            $("#changePw").focus();
                            return;
                        }

                        if (!pwChk) {
                            alert("비밀번호가 일치하지 않습니다.");
                            $("#newPwChk").focus();
                            return;
                        }

                        // 비밀번호 변경 처리
                        this.submit();
                    }
                });

    </script>
</th:block>
</html>
